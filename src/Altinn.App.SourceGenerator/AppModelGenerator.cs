using System.Text;
using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.Text;

namespace Altinn.App.SourceGenerator
{
    /// <summary>
    /// AppModelGenerator is a Source Generator that generates the AppMpdel.cs class implementing <see cref="Altinn.App.Core.Interface.IAppModel"/> 
    /// </summary>
    [Generator]
    public class AppModelGenerator: ISourceGenerator
    {
        /// <inheritdoc />
        public void Initialize(GeneratorInitializationContext context)
        {
        }

        /// <inheritdoc />
        public void Execute(GeneratorExecutionContext context)
        {
            string source = @"// <auto-generated/>
using System;
using Altinn.App.Core.Interface;
using Microsoft.Extensions.Logging;

namespace Altinn.App.Generated.Model;

public class AppModel : IAppModel
{
    private readonly ILogger<AppModel> _logger;
    
    public AppModel(ILogger<AppModel> logger)
    {
        _logger = logger;
    }
    
    public object Create(string classRef)
    {
        _logger.LogInformation($""CreateNewAppModel {classRef}"");

        return Activator.CreateInstance(GetModelType(classRef));
    }

    public Type GetModelType(string classRef)
    {
        _logger.LogInformation($""GetAppModelType {classRef}"");

        return Type.GetType(classRef);
    }
}
";
            context.AddSource("AppModel.g.cs", SourceText.From(source, Encoding.UTF8));
        }
    }
}